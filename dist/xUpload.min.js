"use strict";!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof exports?module.exports=t(require("jquery")):t(jQuery||Zepto)}(function($){function iframeUpload(t,e){this.options=$.extend(defaults,e),this.init(t)}function getBtnCSS(t){return{width:$(t).width(),height:$(t).height(),top:$(t).offset().top,left:$(t).offset().left,position:"absolute",opacity:"0",cursor:"pointer","z-index":1e3}}if(!$)return console.warn("xUpload needs jQuery");var defaults={auto:!0,name:"file",accept:"",multiple:!1,url:"/upload",maxSize:4194304,data:{},onSelect:function(t,e,i){},onSuccess:function(t){},onError:function(t){},onProgress:function(t){}},htmlUpload=function(t,e){this.file="",this.options=$.extend(defaults,e),this.init(t)},iframeNum=0,iframeLoadFirst=0;htmlUpload.prototype={init:function(t){var e=this,i=$('<input type="file" />').css(getBtnCSS(t));if(e.options.multiple&&i.attr("multiple","multiple"),e.options.accept){for(var o=e.options.accept.split(","),n=getMIME(),a="",s=0;s<o.length;s++)n[o[s]]&&(a+=n[o[s]],s<o.length-1&&(a+=","));i.attr("accept",a)}i.on("change",function(t){e.file=this.files;for(var i=0;i<this.files.length;i++)if(this.files[i].size>=e.options.maxSize)return e.options.onSelect(t,e.file,{code:0,message:"file exceed the maximum file limit"}),!1;if(e.options.accept)for(var o=e.options.accept.split(","),n=0;n<this.files.length;n++){var a=this.files[n].name.split(".");if($.inArray(a[a.length-1],o)<0)return e.options.onSelect(t,e.file,{code:1,message:"file type is not accept"}),!1}e.options.onSelect(t,e.file,null),e.options.auto&&e.upload()}),$("body").append(i)},upload:function(){var _this=this,formData=new FormData;if(_this.options.multiple)for(var i=0;i<_this.file.length;i++)formData.append(_this.options.name+"[]",_this.file[i]);else formData.append(_this.options.name,_this.file[0]);if(this.options.data)for(var key in this.options.data)formData.append(key,this.options.data[key]);var xhr=new XMLHttpRequest;xhr.open("POST",_this.options.url,!0),xhr.onprogress=function(t){_this.options.onProgress(t)},xhr.onload=function(event){if(200==xhr.status){var data=eval("("+xhr.responseText+")");0==data.status?_this.options.onSuccess(data):_this.options.onError()}else _this.options.onError(xhr.statusText)},xhr.send(formData)}},iframeUpload.prototype={init:function(t){var e=this;iframeNum++;var i=$('<iframe name="iframe_'+iframeNum+'" style="display:none"></iframe>'),o=$('<form method="post" target="iframe_'+iframeNum+'" action="'+e.options.url+'" name="form_'+iframeNum+'" enctype="multipart/form-data"></form>'),n=$('<input type="file" name="'+e.options.name+'" />').css(getBtnCSS(t));n.on("change",function(t){var i=$(this).val();if(e.options.accept){var o=e.options.accept.split(","),n=i.split(",");if($.inArray(n[n.length-1],o)<0)return e.options.onSelect(t,i,{code:1,message:"file type is not accept"}),!1}e.options.onSelect(t,i,null),this.options.auto&&e.upload(this)});for(key in this.options.data)n+='<input type="hidden" name="'+key+'" value="'+this.options.data[key]+'">';o.append(n),i.load(function(){if(0!=iframeLoadFirst){var t=$(this).contents().get(0),i=$(t).find("body").text();"json"==e.options.dataType&&(i=window.eval("("+i+")")),e.options.onSuccess(i)}iframeLoadFirst=1}),$("body").append(i).append(o)},upload:function(t){$(t).parents("form").submit()}},$.fn.xUpload=function(t){return this.each(function(){return window.FormData?new htmlUpload(this,t):new iframeUpload(this,t)})}});